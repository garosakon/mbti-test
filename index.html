<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>全方位性格測驗V1.0</title>

  <!-- 核心庫 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.320.0/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ✅ 題庫外掛（請確保同資料夾有 question-bank.js） -->
  <script src="./question-bank.js"></script>

  <script src="./personality-analysis.js"></script>

  <style>
    body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    [x-cloak] { display: none !important; }

    /* 動畫效果 */
    .fade-enter-active { transition: all 0.4s ease-out; }
    .fade-enter { opacity: 0; transform: translateY(10px); }

    .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* 圓點按鈕互動樣式 */
    .btn-dot { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .btn-dot:active { transform: scale(0.8); }
    .btn-dot:hover { transform: scale(1.1); }

    /* 載入遮罩 */
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <script>
    function app() {
      const QB = window.QUESTION_BANK;

      const PA = window.PERSONALITY_ANALYSIS;

      return {
        isLoading: true,
        mode: 'HOME', // HOME, PRO93, FULL360, RESULT_93, RESULT_360
        analysisLib: PA ?? { mbti: {}, aohc: {}, dimensions: {} },

        // --- 93題版數據 ---
        q93_list: QB?.q93 ?? [],
        q93_index: 0,
        q93_answers: {},
        q93_transition: false,

        // --- 全方位版數據 ---
        step360: 'INTRO', // INTRO, MBTI, T1, AOHC
        index360_mbti: 0,
        index360_t1: 0,
        index360_aohc: 0,

        answers360: { mbti: {}, t1: {}, aohc: {} },

        // ✅ 題庫改由外部檔案提供
        data360_mbti: QB?.q360?.mbti ?? [],
        data360_t1: QB?.q360?.t1 ?? [],
        data360_aohc: QB?.q360?.aohc ?? [],

        result: {},
        history: [],
        saveName: '',

        mbtiDescriptions: {
          "INTJ": "完美主義 (建築師)", "INTP": "熱愛知識 (邏輯學家)", "ENTJ": "天生領導 (指揮官)", "ENTP": "智力挑戰 (辯論家)",
          "INFJ": "神秘激勵 (提倡者)", "INFP": "詩意善良 (調停者)", "ENFJ": "魅力領導 (主人公)", "ENFP": "熱情創造 (競選者)",
          "ISTJ": "可靠實際 (物流師)", "ISFJ": "溫暖負責 (守衛者)", "ESTJ": "高效管理 (總經理)", "ESFJ": "熱心助人 (執政官)",
          "ISTP": "大膽實作 (鑑賞家)", "ISFP": "靈活藝術 (探險家)", "ESTP": "精力充沛 (企業家)", "ESFP": "熱情自發 (表演者)"
        },
        mbtiLabels: {
          'E': 'E (外向)', 'I': 'I (內向)',
          'S': 'S (感覺)', 'N': 'N (直覺)',
          'T': 'T (思考)', 'F': 'F (情感)',
          'J': 'J (判斷)', 'P': 'P (感知)'
        },

        getMbtiProfile(code) {
          try { return this.analysisLib?.mbti?.[code] || null; } catch (e) { return null; }
        },
        getAohcProfile(code) {
          try { return this.analysisLib?.aohc?.[code] || null; } catch (e) { return null; }
        },


        refreshIcons() {
          if (typeof lucide === 'undefined') return;
          this.$nextTick(() => lucide.createIcons());
        },

        init() {
          if (!QB) console.error("QUESTION_BANK not loaded. Check question-bank.js path.");
          setTimeout(() => {
            this.isLoading = false;
            this.loadHistory();
            this.refreshIcons();

            // ✅ UI切換後重畫 icon（不然 x-if 新插入的 icon 會空白）
            this.$watch('mode', () => this.refreshIcons());
            this.$watch('step360', () => this.refreshIcons());
          }, 300);
        },

        loadHistory() {
          const saved = localStorage.getItem('mbti_universal_history');
          if (saved) this.history = JSON.parse(saved);
        },

        // ------------------ 93題版邏輯 ------------------
        // 93題: 6分制 (1~6)
        // 1:非常同意A (3分), 2:同意A (2分), 3:有點同意A (1分)
        // 4:有點同意B (1分), 5:同意B (2分), 6:非常同意B (3分)
        select93Option(val) {
          this.q93_answers[this.q93_list[this.q93_index].id] = val;
          setTimeout(() => {
            if (this.q93_index < this.q93_list.length - 1) {
              this.q93_transition = true;
              setTimeout(() => {
                this.q93_index++;
                this.q93_transition = false;
                window.scrollTo({ top: 0 });
              }, 200);
            } else {
              this.calc93Result();
            }
          }, 250);
        },

        calc93Result() {
          let s = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };

          this.q93_list.forEach(q => {
            const val = this.q93_answers[q.id];
            if (!val) return;

            let sa = 0, sb = 0;
            if (val <= 3) sa = 4 - val;   // 1->3, 2->2, 3->1
            else sb = val - 3;            // 4->1, 5->2, 6->3

            const aDim = q.dims?.a;
            const bDim = q.dims?.b;
            if (!aDim || !bDim) return;

            s[aDim] += sa;
            s[bDim] += sb;
          });

          this.finishResult('PRO93', s);
        },

        // ------------------ 全方位版邏輯 ------------------

        // MBTI 32題 (6分制)
        select360Mbti(score) {
          this.answers360.mbti[this.data360_mbti[this.index360_mbti].id] = score;
          setTimeout(() => {
            if (this.index360_mbti < this.data360_mbti.length - 1) {
              this.q93_transition = true;
              setTimeout(() => {
                this.index360_mbti++;
                this.q93_transition = false;
                window.scrollTo({ top: 0 });
              }, 200);
            } else {
              this.step360 = 'T1';
              window.scrollTo({ top: 0 });
            }
          }, 250);
        },

        // 行為 16題 (二選一)
        select360T1(val) {
          this.answers360.t1[this.data360_t1[this.index360_t1].id] = val;
          setTimeout(() => {
            if (this.index360_t1 < this.data360_t1.length - 1) {
              this.q93_transition = true;
              setTimeout(() => {
                this.index360_t1++;
                this.q93_transition = false;
                window.scrollTo({ top: 0 });
              }, 200);
            } else {
              this.step360 = 'AOHC';
              window.scrollTo({ top: 0 });
            }
          }, 250);
        },

        // 價值觀 12題 (點擊排序)
        get currentAohcRow() { return this.answers360.aohc[this.data360_aohc[this.index360_aohc].id] || {}; },
        get currentAohcCount() { return Object.keys(this.currentAohcRow).length; },

        select360Aohc(type) {
          const rowId = this.data360_aohc[this.index360_aohc].id;
          let row = this.answers360.aohc[rowId] || {};
          if (row[type]) return; // 已選過

          const nextScore = 4 - Object.keys(row).length; // 4,3,2,1
          row[type] = nextScore;
          this.answers360.aohc[rowId] = { ...row };

          if (nextScore === 1) {
            setTimeout(() => {
              if (this.index360_aohc < this.data360_aohc.length - 1) {
                this.q93_transition = true;
                setTimeout(() => {
                  this.index360_aohc++;
                  this.q93_transition = false;
                  window.scrollTo({ top: 0 });
                }, 300);
              } else {
                this.calc360Result();
              }
            }, 400);
          }
        },

        resetAohcCurrent() {
          const rowId = this.data360_aohc[this.index360_aohc].id;
          this.answers360.aohc[rowId] = {};
        },

        calc360Result() {
          // MBTI (6分制)
          let s = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };
          this.data360_mbti.forEach(q => {
            const val = this.answers360.mbti[q.id] || 0;
            let sa = 0, sb = 0;
            if (val <= 3) sa = 4 - val;
            else sb = val - 3;
            s[q.dimA] += sa;
            s[q.dimB] += sb;
          });

          // T1
          let t1 = { a1:0, a2:0, b1:0, b2:0 };
          Object.values(this.answers360.t1).forEach(v => {
            if (v === 'A1') t1.a1++;
            if (v === 'A2') t1.a2++;
            if (v === 'B1') t1.b1++;
            if (v === 'B2') t1.b2++;
          });
          const t1Code = (t1.a1 >= t1.a2 && t1.b2 >= t1.b1) ? 'O'
                        : (t1.a1 >= t1.a2) ? 'H'
                        : (t1.b2 >= t1.b1) ? 'C'
                        : 'A';

          // AOHC
          let ac = { C:0, O:0, H:0, A:0 };
          Object.values(this.answers360.aohc).forEach(r => {
            ac.C += (r.C || 0);
            ac.O += (r.O || 0);
            ac.H += (r.H || 0);
            ac.A += (r.A || 0);
          });
          let maxA = Math.max(ac.C, ac.O, ac.H, ac.A);
          let aCode = (ac.C === maxA) ? 'C' : (ac.O === maxA) ? 'O' : (ac.H === maxA) ? 'H' : 'A';

          this.finishResult('FULL360', s, { t1Code, aCode, ac });
        },

        finishResult(mode, scores, extras = {}) {
          const mCode =
            (scores.E >= scores.I ? 'E' : 'I') +
            (scores.S >= scores.N ? 'S' : 'N') +
            (scores.T >= scores.F ? 'T' : 'F') +
            (scores.J >= scores.P ? 'J' : 'P');

          const total = {
            E: scores.E + scores.I,
            S: scores.S + scores.N,
            T: scores.T + scores.F,
            J: scores.J + scores.P
          };

          const mbtiPercents = {
            E: Math.round(scores.E/total.E*100) || 50, I: Math.round(scores.I/total.E*100) || 50,
            S: Math.round(scores.S/total.S*100) || 50, N: Math.round(scores.N/total.S*100) || 50,
            T: Math.round(scores.T/total.T*100) || 50, F: Math.round(scores.F/total.T*100) || 50,
            J: Math.round(scores.J/total.J*100) || 50, P: Math.round(scores.P/total.J*100) || 50
          };

          const dimPairs = [['E','I'], ['S','N'], ['T','F'], ['J','P']];
          const dimInsights = dimPairs.map(([a,b]) => {
            const pA = mbtiPercents[a] ?? 50;
            const diff = Math.abs(pA - 50);
            const level = diff < 8 ? '平衡' : diff < 18 ? '略偏' : diff < 28 ? '偏' : '明顯偏';
            const side = pA >= 50 ? a : b;

            const info = this.analysisLib?.dimensions?.[side] || {};
            if (level === '平衡') {
              const ia = this.analysisLib?.dimensions?.[a] || {};
              const ib = this.analysisLib?.dimensions?.[b] || {};
              const aCore = ia.core || a;
              const bCore = ib.core || b;
              return { pair: `${a}-${b}`, side, level, text: `平衡：可在「${aCore}」與「${bCore}」間切換，依情境調整。` };
            }
            const sideLabel = info.label || side;
            const core = info.core ? `${info.core}。` : '';
            const high = info.high ? `常見表現：${info.high}。` : '';
            return { pair: `${a}-${b}`, side, level, text: `${level}${sideLabel}：${core}${high}` };
          });


          const typeMap = { 'C':'掌控型 (Commander)', 'O':'影響型 (Optimist)', 'H':'穩健型 (Harmonizer)', 'A':'分析型 (Analytical)' };

          this.result = {
            mode: mode,
            date: new Date().toLocaleString(),
            mbtiCode: mCode,
            mbtiDesc: this.mbtiDescriptions[mCode],
            mbtiPercents: mbtiPercents,
            dimInsights: dimInsights,

            // Extras for 360
            t1Name: extras.t1Code ? typeMap[extras.t1Code] : '',
            t1Code: extras.t1Code,
            aohcName: extras.aCode ? typeMap[extras.aCode] : '',
            aohcCode: extras.aCode,
            aohcStats: extras.ac ? [
              { name:'掌控', percent: extras.ac.C/48*100, color:'bg-red-500' },
              { name:'影響', percent: extras.ac.O/48*100, color:'bg-amber-500' },
              { name:'穩健', percent: extras.ac.H/48*100, color:'bg-emerald-500' },
              { name:'分析', percent: extras.ac.A/48*100, color:'bg-blue-500' }
            ] : []
          };

          this.mode = mode === 'PRO93' ? 'RESULT_93' : 'RESULT_360';
        },

        // 通用功能
        saveRecord() {
          if (!this.saveName) return alert('請輸入名字');
          this.history.unshift({ ...this.result, name: this.saveName, id: Date.now() });
          localStorage.setItem('mbti_universal_history', JSON.stringify(this.history));
          alert('已儲存！');
          this.mode = 'HOME';
          this.saveName = '';

          this.q93_index = 0;
          this.q93_answers = {};

          this.index360_mbti = 0;
          this.index360_t1 = 0;
          this.index360_aohc = 0;
          this.answers360 = { mbti:{}, t1:{}, aohc:{} };
          this.step360 = 'INTRO';
        },

        deleteRecord(idx) {
          if (confirm('刪除?')) {
            this.history.splice(idx, 1);
            localStorage.setItem('mbti_universal_history', JSON.stringify(this.history));
          }
        },

        loadRecord(rec) {
          this.result = rec;
          this.mode = rec.mode === 'PRO93' ? 'RESULT_93' : 'RESULT_360';
          window.scrollTo({ top: 0 });
        },

        downloadImage() {
          const el = document.getElementById(this.mode === 'RESULT_93' ? 'result-card-93' : 'result-card-360');
          const temp = document.createElement('div');

          if (this.saveName) {
            temp.innerHTML = `<div class='text-center text-lg font-bold text-gray-700 py-2'>${this.saveName} 的測驗結果</div>`;
            el.insertBefore(temp, el.firstChild);
          }

          html2canvas(el, { scale: 2, backgroundColor: "#fff" }).then(canvas => {
            if (this.saveName) el.removeChild(temp);
            const a = document.createElement('a');
            a.download = `MBTI-${Date.now()}.png`;
            a.href = canvas.toDataURL();
            a.click();
          });
        },

        copyText() {
          const r = this.result;
          const text = r.mode === 'PRO93'
            ? `MBTI: ${r.mbtiCode}\nE:${r.mbtiPercents.E}% / I:${r.mbtiPercents.I}%\nS:${r.mbtiPercents.S}% / N:${r.mbtiPercents.N}%\nT:${r.mbtiPercents.T}% / F:${r.mbtiPercents.F}%\nJ:${r.mbtiPercents.J}% / P:${r.mbtiPercents.P}%`
            : `MBTI: ${r.mbtiCode}\n外顯: ${r.t1Name}\n內在: ${r.aohcName}`;
          navigator.clipboard.writeText(text).then(() => alert('已複製'));
        }
      };
    }
  </script>
</head>

<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700"
      x-data="app()" x-init="init()">

  <div x-show="isLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
    <div class="loader mb-4"></div>
    <div class="text-slate-500 font-bold">載入中...</div>
  </div>

  <div class="min-h-screen flex flex-col items-center p-4 max-w-xl mx-auto" x-cloak>
    <nav class="w-full flex justify-between items-center mb-6 px-2">
      <div class="flex items-center gap-2 cursor-pointer" @click="mode='HOME'">
        <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg">
          <i data-lucide="brain-circuit" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-lg text-slate-700">全方位性格測驗</span>
      </div>
      <button @click="mode='HOME'" class="text-sm font-bold text-slate-500 hover:text-indigo-600" x-show="mode !== 'HOME'">回首頁</button>
    </nav>

    <!-- 首頁 -->
    <template x-if="mode === 'HOME'">
      <div class="w-full space-y-6 fade-enter-active">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-extrabold text-slate-900 mb-2">探索你的內在宇宙</h1>
          <p class="text-slate-500">選擇適合您的測驗模式</p>
        </div>

        <div class="grid gap-4">
          <div @click="mode='PRO93'; q93_index=0; q93_answers={};"
               class="bg-white p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-indigo-500 cursor-pointer relative overflow-hidden group">
            <div class="absolute top-0 right-0 bg-indigo-100 text-indigo-700 px-3 py-1 text-xs font-bold rounded-bl-xl">最準確</div>
            <div class="flex items-center gap-4">
              <div class="bg-indigo-100 p-3 rounded-full text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                <i data-lucide="graduation-cap" class="w-8 h-8"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold">專業深度版 (93題)</h3>
                <p class="text-xs text-slate-400">完整 MBTI 題庫，細膩 6 階彩色圓點評分，精確度最高。</p>
              </div>
            </div>
          </div>

          <div @click="mode='FULL360'; step360='INTRO'; index360_mbti=0; index360_t1=0; index360_aohc=0; answers360={mbti:{},t1:{},aohc:{}};"
               class="bg-white p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-emerald-500 cursor-pointer relative overflow-hidden group">
            <div class="absolute top-0 right-0 bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-bold rounded-bl-xl">多元分析</div>
            <div class="flex items-center gap-4">
              <div class="bg-emerald-100 p-3 rounded-full text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                <i data-lucide="layers" class="w-8 h-8"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold">全方位速測版</h3>
                <p class="text-xs text-slate-400">MBTI (32題) + 行為 + 價值觀，多維度分析。</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 歷史紀錄 -->
        <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100" x-show="history.length > 0">
          <h3 class="font-bold text-slate-700 mb-3 text-sm">歷史紀錄</h3>
          <div class="space-y-2 max-h-40 overflow-y-auto">
            <template x-for="(rec, idx) in history" :key="rec.id">
              <div class="flex justify-between items-center p-2 bg-slate-50 rounded text-sm">
                <div @click="loadRecord(rec)" class="cursor-pointer flex-1">
                  <span class="font-bold" x-text="rec.name"></span>
                  <span class="text-xs text-slate-500 ml-2" x-text="rec.mbtiCode"></span>
                </div>
                <button @click="deleteRecord(idx)" class="text-red-300 hover:text-red-500">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>

    <!-- 93題 測驗區 -->
    <template x-if="mode === 'PRO93'">
      <div class="w-full flex flex-col justify-center min-h-[60vh] fade-enter-active">
        <div class="mb-6">
          <div class="flex justify-between text-xs font-bold text-indigo-600 mb-2">
            <span>Q <span x-text="q93_index + 1"></span> / <span x-text="q93_list.length"></span></span>
            <span x-text="Math.round((q93_index/q93_list.length)*100) + '%'"></span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-1.5">
            <div class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300"
                 :style="'width:' + ((q93_index/q93_list.length)*100) + '%'"></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 relative overflow-hidden min-h-[400px] flex flex-col"
             :class="{'slide-up': q93_transition}">
          <h2 class="text-xl font-bold text-slate-800 mb-4 flex-1" x-text="q93_list[q93_index].text"></h2>

          <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="text-xs text-indigo-600 font-bold mb-1">選項 A</div>
            <div class="text-xs text-emerald-600 font-bold mb-1 text-right">選項 B</div>

            <div class="bg-indigo-50 text-indigo-900 p-3 rounded-lg text-sm font-medium leading-tight h-16 flex items-center border border-indigo-100"
                 x-text="q93_list[q93_index].optA"></div>

            <div class="bg-emerald-50 text-emerald-900 p-3 rounded-lg text-sm font-medium leading-tight h-16 flex items-center justify-end text-right border border-emerald-100"
                 x-text="q93_list[q93_index].optB"></div>
          </div>

          <!-- 圓點按鈕區 -->
          <div class="flex justify-center items-center gap-2 sm:gap-4 mt-auto">
            <!-- A群組 (左/紫) -->
            <div class="flex items-center gap-2">
              <div class="flex flex-col items-center">
                <button @click="select93Option(1)" class="btn-dot w-12 h-12 rounded-full bg-indigo-600 shadow-md hover:bg-indigo-700"></button>
                <span class="text-[10px] text-indigo-600 font-bold mt-1">非常同意</span>
              </div>
              <div class="flex flex-col items-center">
                <button @click="select93Option(2)" class="btn-dot w-10 h-10 rounded-full bg-indigo-400 shadow-md hover:bg-indigo-500"></button>
                <span class="text-[10px] text-indigo-400 font-bold mt-1">同意</span>
              </div>
              <div class="flex flex-col items-center">
                <button @click="select93Option(3)" class="btn-dot w-8 h-8 rounded-full bg-indigo-300 shadow-md hover:bg-indigo-400"></button>
                <span class="text-[10px] text-indigo-300 font-bold mt-1">有點同意</span>
              </div>
            </div>

            <!-- 分隔線 -->
            <div class="w-px h-10 bg-slate-200"></div>

            <!-- B群組 (右/綠) -->
            <div class="flex items-center gap-2">
              <div class="flex flex-col items-center">
                <button @click="select93Option(4)" class="btn-dot w-8 h-8 rounded-full bg-emerald-300 shadow-md hover:bg-emerald-400"></button>
                <span class="text-[10px] text-emerald-300 font-bold mt-1">有點同意</span>
              </div>
              <div class="flex flex-col items-center">
                <button @click="select93Option(5)" class="btn-dot w-10 h-10 rounded-full bg-emerald-400 shadow-md hover:bg-emerald-500"></button>
                <span class="text-[10px] text-emerald-400 font-bold mt-1">同意</span>
              </div>
              <div class="flex flex-col items-center">
                <button @click="select93Option(6)" class="btn-dot w-12 h-12 rounded-full bg-emerald-600 shadow-md hover:bg-emerald-700"></button>
                <span class="text-[10px] text-emerald-600 font-bold mt-1">非常同意</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-center">
          <button @click="if(q93_index>0) q93_index--" class="text-slate-400 text-xs font-bold p-2" x-show="q93_index > 0">上一題</button>
        </div>
      </div>
    </template>

    <!-- 全方位版 (Full 360) -->
    <template x-if="mode === 'FULL360'">
      <div class="w-full fade-enter-active min-h-[60vh] flex flex-col justify-center">

        <!-- 介紹頁 -->
        <div x-show="step360 === 'INTRO'" class="bg-white p-8 rounded-2xl shadow-xl text-center">
          <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600">
            <i data-lucide="play" class="w-8 h-8"></i>
          </div>
          <h2 class="text-xl font-bold mb-2">準備好了嗎？</h2>
          <p class="text-slate-500 text-sm mb-6">本測驗分為三個階段，請依直覺回答。</p>
          <button @click="step360='MBTI'" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-200">開始測驗</button>
        </div>

        <!-- 階段1: MBTI 32題 -->
        <div x-show="step360 === 'MBTI'">
          <div class="mb-4 flex justify-between items-end">
            <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Part 1: 心理傾向</span>
            <span class="text-xs font-bold text-slate-400" x-text="(index360_mbti+1)+'/32'"></span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-1 mb-6">
            <div class="bg-emerald-500 h-1 rounded-full transition-all" :style="'width:' + ((index360_mbti/32)*100) + '%'"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-6 relative overflow-hidden" :class="{'slide-up': q93_transition}">
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="bg-indigo-50 text-indigo-900 p-4 rounded-xl text-center flex items-center justify-center min-h-[80px] font-bold border border-indigo-100"
                   x-text="data360_mbti[index360_mbti].textA"></div>
              <div class="bg-emerald-50 text-emerald-900 p-4 rounded-xl text-center flex items-center justify-center min-h-[80px] font-bold border border-emerald-100"
                   x-text="data360_mbti[index360_mbti].textB"></div>
            </div>

            <!-- 圓點按鈕區 -->
            <div class="flex justify-center items-center gap-2 sm:gap-4 mt-4">
              <!-- A群組 -->
              <div class="flex items-center gap-2">
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(1)" class="btn-dot w-12 h-12 rounded-full bg-indigo-600 shadow-md hover:bg-indigo-700"></button>
                  <span class="text-[10px] text-indigo-600 font-bold mt-1">非常同意</span>
                </div>
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(2)" class="btn-dot w-10 h-10 rounded-full bg-indigo-400 shadow-md hover:bg-indigo-500"></button>
                  <span class="text-[10px] text-indigo-400 font-bold mt-1">同意</span>
                </div>
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(3)" class="btn-dot w-8 h-8 rounded-full bg-indigo-300 shadow-md hover:bg-indigo-400"></button>
                  <span class="text-[10px] text-indigo-300 font-bold mt-1">有點同意</span>
                </div>
              </div>

              <div class="w-px h-10 bg-slate-200"></div>

              <!-- B群組 -->
              <div class="flex items-center gap-2">
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(4)" class="btn-dot w-8 h-8 rounded-full bg-emerald-300 shadow-md hover:bg-emerald-400"></button>
                  <span class="text-[10px] text-emerald-300 font-bold mt-1">有點同意</span>
                </div>
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(5)" class="btn-dot w-10 h-10 rounded-full bg-emerald-400 shadow-md hover:bg-emerald-500"></button>
                  <span class="text-[10px] text-emerald-400 font-bold mt-1">同意</span>
                </div>
                <div class="flex flex-col items-center">
                  <button @click="select360Mbti(6)" class="btn-dot w-12 h-12 rounded-full bg-emerald-600 shadow-md hover:bg-emerald-700"></button>
                  <span class="text-[10px] text-emerald-600 font-bold mt-1">非常同意</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 階段2: 行為 (T1) 16題 -->
        <div x-show="step360 === 'T1'">
          <div class="mb-4 flex justify-between items-end">
            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Part 2: 外顯行為</span>
            <span class="text-xs font-bold text-slate-400" x-text="(index360_t1+1)+'/16'"></span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-1 mb-6">
            <div class="bg-blue-500 h-1 rounded-full transition-all" :style="'width:' + ((index360_t1/16)*100) + '%'"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-8 relative overflow-hidden text-center" :class="{'slide-up': q93_transition}">
            <h3 class="text-lg font-bold text-slate-700 mb-6">哪一個更像你？</h3>
            <div class="space-y-4">
              <button @click="select360T1(data360_t1[index360_t1].pairA.val)"
                      class="w-full p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                <span class="font-bold text-slate-700 group-hover:text-blue-700 text-lg"
                      x-text="data360_t1[index360_t1].pairA.text"></span>
              </button>
              <div class="text-xs text-slate-300 font-bold">OR</div>
              <button @click="select360T1(data360_t1[index360_t1].pairB.val)"
                      class="w-full p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                <span class="font-bold text-slate-700 group-hover:text-blue-700 text-lg"
                      x-text="data360_t1[index360_t1].pairB.text"></span>
              </button>
            </div>
          </div>
        </div>

        <!-- 階段3: 價值觀 (AOHC) 12題 -->
        <div x-show="step360 === 'AOHC'">
          <div class="mb-4 flex justify-between items-end">
            <span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">Part 3: 價值觀</span>
            <span class="text-xs font-bold text-slate-400" x-text="(index360_aohc+1)+'/12'"></span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-1 mb-6">
            <div class="bg-orange-500 h-1 rounded-full transition-all" :style="'width:' + ((index360_aohc/12)*100) + '%'"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-6 relative overflow-hidden" :class="{'slide-up': q93_transition}">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-slate-700">請依序點擊 (最像 -> 最不像)</h3>
              <button @click="resetAohcCurrent" class="text-xs text-slate-400 hover:text-red-500 flex items-center gap-1">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> 重選
              </button>
            </div>

            <div class="grid grid-cols-1 gap-3">
              <template x-for="word in data360_aohc[index360_aohc].words" :key="word.type">
                <button @click="select360Aohc(word.type)"
                        class="w-full p-4 rounded-xl border-2 transition-all flex justify-between items-center"
                        :class="currentAohcRow[word.type] ? 'border-orange-500 bg-orange-50' : 'border-slate-100 hover:border-slate-300'">
                  <span class="font-bold text-lg" x-text="word.text"></span>
                  <span x-show="currentAohcRow[word.type]"
                        class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold shadow"
                        x-text="currentAohcRow[word.type]"></span>
                </button>
              </template>
            </div>
          </div>
        </div>

      </div>
    </template>

    <!-- 結果頁 -->
    <template x-if="mode.startsWith('RESULT')">
      <div class="w-full fade-enter-active space-y-6">

        <!-- 93 結果卡 -->
        <div x-show="mode==='RESULT_93'" id="result-card-93" class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
          <div class="bg-gradient-to-br from-indigo-600 to-blue-600 p-8 text-white text-center">
            <div class="text-xs font-bold opacity-60 mb-2 tracking-widest">MBTI PROFESIONAL</div>
            <h2 class="text-5xl font-extrabold mb-1" x-text="result.mbtiCode"></h2>
            <p class="text-xl opacity-90" x-text="result.mbtiDesc"></p>
          </div>

          <div class="p-6 space-y-4">
            <template x-for="dim in ['E-I','S-N','T-F','J-P']">
              <div>
                <div class="flex justify-between text-xs font-bold text-slate-500 mb-1">
                  <span x-text="mbtiLabels[dim.split('-')[0]] + ' ' + result.mbtiPercents[dim.split('-')[0]] + '%'"></span>
                  <span x-text="mbtiLabels[dim.split('-')[1]] + ' ' + result.mbtiPercents[dim.split('-')[1]] + '%'"></span>
                </div>
                <div class="h-2 bg-slate-100 rounded-full overflow-hidden flex">
                  <div class="bg-indigo-500 h-full" :style="'width:'+result.mbtiPercents[dim.split('-')[0]]+'%'"></div>
                  <div class="bg-slate-300 h-full" :style="'width:'+result.mbtiPercents[dim.split('-')[1]]+'%'"></div>
                </div>
              </div>
            </template>
            <div class="text-xs text-slate-400 text-center mt-4">分數越極端代表特質越明顯，接近 50% 代表具備彈性。</div>
          </div>
        </div>

        <div x-show="mode==='RESULT_93'" class="p-6 border-t border-slate-100 space-y-5">
          <div class="flex items-center gap-2">
            <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg">
              <i data-lucide="book-open" class="w-4 h-4"></i>
            </div>
            <h3 class="font-extrabold text-slate-800">完整解析</h3>
          </div>

          <template x-if="getMbtiProfile(result.mbtiCode)">
            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
              <div class="text-sm font-bold text-slate-800" x-text="getMbtiProfile(result.mbtiCode).tagline"></div>
              <div class="text-sm text-slate-600 mt-2 leading-relaxed" x-text="getMbtiProfile(result.mbtiCode).overview"></div>
            </div>
          </template>

          <template x-if="getMbtiProfile(result.mbtiCode)">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">優勢</div>
                <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                  <template x-for="item in getMbtiProfile(result.mbtiCode).strengths" :key="item">
                    <li x-text="item"></li>
                  </template>
                </ul>
              </div>

              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">可能的盲點</div>
                <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                  <template x-for="item in getMbtiProfile(result.mbtiCode).risks" :key="item">
                    <li x-text="item"></li>
                  </template>
                </ul>
              </div>

              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">工作風格</div>
                <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                  <template x-for="item in getMbtiProfile(result.mbtiCode).work" :key="item">
                    <li x-text="item"></li>
                  </template>
                </ul>
              </div>

              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">關係互動</div>
                <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                  <template x-for="item in getMbtiProfile(result.mbtiCode).relationships" :key="item">
                    <li x-text="item"></li>
                  </template>
                </ul>
              </div>
            </div>
          </template>

          <template x-if="getMbtiProfile(result.mbtiCode)">
            <div class="bg-white rounded-2xl p-4 border border-slate-100">
              <div class="text-xs font-extrabold text-slate-500 mb-2">成長建議</div>
              <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                <template x-for="item in getMbtiProfile(result.mbtiCode).growth" :key="item">
                  <li x-text="item"></li>
                </template>
              </ul>
            </div>
          </template>

          <div class="bg-white rounded-2xl p-4 border border-slate-100">
            <div class="text-xs font-extrabold text-slate-500 mb-2">傾向解讀（看百分比差距）</div>
            <div class="space-y-2">
              <template x-for="d in result.dimInsights" :key="d.pair">
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                  <div class="flex items-center justify-between gap-3 text-xs font-bold text-slate-600">
                    <span x-text="d.pair"></span>
                    <span class="text-indigo-600" x-text="d.level"></span>
                  </div>
                  <div class="text-sm text-slate-600 mt-1 leading-relaxed" x-text="d.text"></div>
                </div>
              </template>
            </div>
            <div class="text-[11px] text-slate-400 mt-3">提示：這是「偏好模式」的解讀，不是能力高低。高分代表你更常用那套模式。</div>
          </div>
        </div>

        <!-- 360 結果卡 -->
        <div x-show="mode==='RESULT_360'" id="result-card-360" class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
          <div class="bg-slate-800 p-8 text-white text-center">
            <div class="text-xs font-bold opacity-60 mb-2 tracking-widest">360 ANALYSIS</div>
            <div class="flex justify-center items-center gap-2 mb-2">
              <span class="text-4xl font-extrabold" x-text="result.mbtiCode"></span>
              <span class="text-2xl text-yellow-400 font-bold">+</span>
              <span class="text-4xl font-extrabold text-yellow-400" x-text="result.aohcCode"></span>
            </div>
            <p class="text-sm opacity-80">外顯: <span x-text="result.t1Name"></span> | 內在: <span x-text="result.aohcName"></span></p>
          </div>

          <div class="p-6 grid grid-cols-1 gap-6">
            <div>
              <h4 class="text-xs font-bold text-slate-400 mb-3">MBTI 傾向</h4>
              <template x-for="dim in ['E-I','S-N','T-F','J-P']">
                <div class="mb-2">
                  <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden flex">
                    <div class="bg-indigo-600 h-full" :style="'width:'+result.mbtiPercents[dim.split('-')[0]]+'%'"></div>
                  </div>
                  <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                    <span x-text="mbtiLabels[dim.split('-')[0]]"></span><span x-text="mbtiLabels[dim.split('-')[1]]"></span>
                  </div>
                </div>
              </template>
            </div>

            <div>
              <h4 class="text-xs font-bold text-slate-400 mb-3">價值觀分佈</h4>
              <div class="space-y-2">
                <template x-for="s in result.aohcStats">
                  <div class="flex items-center gap-2 text-xs">
                    <span class="w-8 font-bold text-slate-600" x-text="s.name"></span>
                    <div class="flex-1 bg-slate-100 rounded-full h-1.5 overflow-hidden">
                      <div class="h-full" :class="s.color" :style="'width:'+s.percent+'%'"></div>
                    </div>
                    <span class="w-6 text-right text-slate-400" x-text="Math.round(s.percent)+'%'"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>

        <div class="p-6 border-t border-slate-100 space-y-5">
          <div class="flex items-center gap-2">
            <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg">
              <i data-lucide="book-open" class="w-4 h-4"></i>
            </div>
            <h3 class="font-extrabold text-slate-800">完整解析</h3>
          </div>

          <template x-if="getMbtiProfile(result.mbtiCode)">
            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
              <div class="text-sm font-bold text-slate-800" x-text="getMbtiProfile(result.mbtiCode).tagline"></div>
              <div class="text-sm text-slate-600 mt-2 leading-relaxed" x-text="getMbtiProfile(result.mbtiCode).overview"></div>
            </div>
          </template>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <template x-if="result.t1Code && result.aohcCode && result.t1Code===result.aohcCode && getAohcProfile(result.t1Code)">
              <div class="bg-white rounded-2xl p-4 border border-slate-100 lg:col-span-2">
                <div class="text-xs font-extrabold text-slate-500 mb-2">外顯行為 × 內在價值觀（高度一致）</div>
                <div class="text-sm font-bold text-slate-800">
                  <span x-text="getAohcProfile(result.t1Code).name"></span>
                  <span class="text-slate-400 font-normal">（你呈現出來的樣子，跟你內心真正重視的東西差不多）</span>
                </div>
                <div class="text-sm text-slate-600 mt-2 leading-relaxed" x-text="getAohcProfile(result.t1Code).overview"></div>

                <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <div class="text-xs font-bold text-slate-500 mb-1">強項</div>
                    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                      <template x-for="item in getAohcProfile(result.t1Code).strengths" :key="item">
                        <li x-text="item"></li>
                      </template>
                    </ul>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <div class="text-xs font-bold text-slate-500 mb-1">風險</div>
                    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                      <template x-for="item in getAohcProfile(result.t1Code).risks" :key="item">
                        <li x-text="item"></li>
                      </template>
                    </ul>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <div class="text-xs font-bold text-slate-500 mb-1">建議</div>
                    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                      <template x-for="item in getAohcProfile(result.t1Code).tips" :key="item">
                        <li x-text="item"></li>
                      </template>
                    </ul>
                  </div>
                </div>

                <div class="text-[11px] text-slate-400 mt-3">小提示：一致性高通常代表內耗較少；但也更容易把同一套模式用到底，記得保留「情境切換」的彈性。</div>
              </div>
            </template>
            <template x-if="result.t1Code && getAohcProfile(result.t1Code) && (!result.aohcCode || result.t1Code !== result.aohcCode)">
              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">外顯行為（你給人的第一印象）</div>
                <div class="text-sm font-bold text-slate-800" x-text="getAohcProfile(result.t1Code).name"></div>
                <div class="text-sm text-slate-600 mt-2 leading-relaxed" x-text="getAohcProfile(result.t1Code).overview"></div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">強項</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.t1Code).strengths" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">風險</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.t1Code).risks" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">建議</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.t1Code).tips" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>
              </div>
            </template>

            <template x-if="result.aohcCode && getAohcProfile(result.aohcCode) && (!result.t1Code || result.t1Code !== result.aohcCode)">
              <div class="bg-white rounded-2xl p-4 border border-slate-100">
                <div class="text-xs font-extrabold text-slate-500 mb-2">內在價值觀（你做決策的核心動機）</div>
                <div class="text-sm font-bold text-slate-800" x-text="getAohcProfile(result.aohcCode).name"></div>
                <div class="text-sm text-slate-600 mt-2 leading-relaxed" x-text="getAohcProfile(result.aohcCode).overview"></div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">強項</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.aohcCode).strengths" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">風險</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.aohcCode).risks" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>

                <div class="mt-3">
                  <div class="text-xs font-bold text-slate-500 mb-1">建議</div>
                  <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                    <template x-for="item in getAohcProfile(result.aohcCode).tips" :key="item">
                      <li x-text="item"></li>
                    </template>
                  </ul>
                </div>
              </div>
            </template>
          </div>

          <div class="bg-white rounded-2xl p-4 border border-slate-100">
            <div class="text-xs font-extrabold text-slate-500 mb-2">傾向解讀（看百分比差距）</div>
            <div class="space-y-2">
              <template x-for="d in result.dimInsights" :key="d.pair">
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                  <div class="flex items-center justify-between gap-3 text-xs font-bold text-slate-600">
                    <span x-text="d.pair"></span>
                    <span class="text-indigo-600" x-text="d.level"></span>
                  </div>
                  <div class="text-sm text-slate-600 mt-1 leading-relaxed" x-text="d.text"></div>
                </div>
              </template>
            </div>
            <div class="text-[11px] text-slate-400 mt-3">提示：你同時擁有兩端特質，只是「使用頻率」不同；需要時可以刻意切換。</div>
          </div>
        </div>

        </div>

        <!-- 底部操作 -->
        <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-100 space-y-3">
          <div class="flex gap-2">
            <input type="text" x-model="saveName" class="flex-1 bg-slate-50 border-0 rounded-lg text-sm px-3" placeholder="輸入名字儲存">
            <button @click="saveRecord" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold">儲存</button>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button @click="downloadImage" class="bg-slate-100 text-slate-600 py-3 rounded-lg text-sm font-bold flex justify-center items-center gap-2">
              <i data-lucide="image" class="w-4 h-4"></i> 存圖
            </button>
            <button @click="copyText" class="bg-slate-100 text-slate-600 py-3 rounded-lg text-sm font-bold flex justify-center items-center gap-2">
              <i data-lucide="copy" class="w-4 h-4"></i> 複製
            </button>
          </div>

          <a :href="'https://www.16personalities.com/ch/'+result.mbtiCode+'-personality'"
             target="_blank"
             class="block text-center text-xs text-indigo-400 hover:text-indigo-600 py-2">
            查看詳細性格解析 ->
          </a>
        </div>

      </div>
    </template>

  </div>
</body>
</html>
